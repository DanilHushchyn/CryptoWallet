<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../static/vuexy/assets/"
  data-template="vertical-menu-template"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Chat</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../static/vuexy/assets/img/favicon/wallet-solid.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/fonts/fontawesome.css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/fonts/tabler-icons.css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/fonts/flag-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/css/rtl/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/css/rtl/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="../static/vuexy/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/libs/node-waves/node-waves.css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="../static/vuexy/assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css" />

    <!-- Page CSS -->

    <link rel="stylesheet" href="../static/vuexy/assets/vendor/css/pages/app-chat.css" />
    <!-- Helpers -->
    <script src="../static/vuexy/assets/vendor/js/helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Template customizer: To hide customizer set displayCustomizer value false in config.js.  -->
    <script src="../static/vuexy/assets/vendor/js/template-customizer.js"></script>
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="../static/vuexy/assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo">
            <div class="app-brand-link">
              <span class="app-brand-logo demo">
                    <i class="fa-solid fa-wallet fa-beat" style="color: #6770f0;"></i>
              </span>
              <span class="app-brand-text demo menu-text fw-bold">Crypto Wallet</span>
            </div>

            <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
              <i class="ti menu-toggle-icon d-none d-xl-block ti-sm align-middle"></i>
              <i class="ti ti-x d-block d-xl-none ti-sm align-middle"></i>
            </a>
          </div>

          <div class="menu-inner-shadow"></div>

          <ul class="menu-inner py-1">
            <li class="menu-item">
              <a href="http://127.0.0.1:8000/profile" class="menu-link">
                <i class="menu-icon tf-icons ti ti-user"></i>
                <div>Profile</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="http://127.0.0.1:8000/wallets" class="menu-link">
                <i class="menu-icon tf-icons ti ti-wallet"></i>
                <div>My Wallets</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="http://127.0.0.1:8000/ibay" class="menu-link">
                <i class="menu-icon tf-icons ti ti-shopping-cart"></i>
                <div>Ibay</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="http://127.0.0.1:8000/chat" class="menu-link chat__link">
                <i class="menu-icon tf-icons ti ti-messages"></i>
                <div>Chat</div>
              </a>
            </li>
          </ul>
        </aside>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- / Navbar -->

                    <nav
            class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
            id="layout-navbar"
          >
            <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <!-- User -->
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <div class="avatar avatar-online">
                      <img src="https://crypto.fra1.cdn.digitaloceanspaces.com/crypto/default.png" alt class="h-auto rounded-circle profile__img" />
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <div class="dropdown-item">
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0 me-3">
                            <div class="avatar avatar-online">
                              <img src="https://crypto.fra1.cdn.digitaloceanspaces.com/crypto/default.png" alt class="h-auto rounded-circle profile__img" />
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <span class="fw-semibold d-block profile__username1"></span>
                          </div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                    </li>
                    <li>
                      <div class="dropdown-item logout_btn" target="_blank">
                        <i class="ti ti-logout me-2 ti-sm"></i>
                        <span class="align-middle">Log Out</span>
                      </div>
                    </li>
                  </ul>
                </li>
                <!--/ User -->
              </ul>
            </div>
          </nav>
          <!-- / Navbar -->
          <!-- Content wrapper -->
          <div class="content-wrapper">
             <!-- Content -->

            <div class="container-xxl flex-grow-1 container-p-y pb-0">
              <div class="app-chat card overflow-hidden">
                <div class="row g-0">
                  <!-- Chat & Contacts -->
                  <div
                    class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end"
                    id="app-chat-contacts"
                  >
                    <div class="sidebar-header">
                      <div class="d-flex align-items-center me-3 me-lg-0">
                        <div
                          class="flex-shrink-0 avatar avatar-online me-3"
                          data-bs-toggle="sidebar"
                          data-overlay="app-overlay-ex"
                          data-target="#app-chat-sidebar-left"
                        >
                          <img
                            class="user-avatar rounded-circle cursor-pointer profile__img"
                            src="https://crypto.fra1.cdn.digitaloceanspaces.com/crypto/default.png"
                            alt="Avatar"
                          />
                        </div>
                        <div class="flex-grow-1 input-group input-group-merge rounded-pill">
                          <span class="input-group-text" id="basic-addon-search31"><i class="ti ti-search"></i></span>
                          <input
                            type="text"
                            class="form-control chat-search-input"
                            placeholder="Search..."
                            aria-label="Search..."
                            aria-describedby="basic-addon-search31"
                          />
                        </div>
                      </div>
                      <i
                        class="ti ti-x cursor-pointer d-lg-none d-block position-absolute mt-2 me-1 top-0 end-0"
                        data-overlay
                        data-bs-toggle="sidebar"
                        data-target="#app-chat-contacts"
                      ></i>
                    </div>
                    <hr class="container-m-nx m-0" />
                    <div class="sidebar-body">
                      <div class="chat-contact-list-item-title">
                        <h5 class="text-primary mb-0 px-4 pt-3 pb-2">Online Users</h5>
                      </div>
                      <!-- Chats -->
                      <ul class="list-unstyled chat-contact-list" id="online-users-list">
<!--                        <li class="chat-contact-list-item chat-list-item-0 d-none">-->
<!--                          <h6 class="text-muted mb-0">No Chats Found</h6>-->
<!--                        </li>-->
                      </ul>
                    </div>
                  </div>
                  <!-- /Chat contacts -->

                  <!-- Chat History -->
                  <div class="col app-chat-history bg-body">
                    <div class="chat-history-wrapper">
                      <div id="chatBody" class="chat-history-body bg-body">
                        <ul id="chatHistory" class="list-unstyled chat-history">

                        </ul>
                      </div>
                      <!-- Chat message form -->
                      <div class="chat-history-footer shadow-sm">
                        <div class="form-send-message d-flex justify-content-between align-items-center">
                          <input
                            class="form-control message-input border-0 me-3 shadow-none" id="messageText"
                            placeholder="Type your message here"
                          />
                          <div class="message-actions d-flex align-items-center">
                            <label for="imageInput" class="form-label mb-0">
                              <i class="ti ti-photo ti-sm cursor-pointer mx-3"></i>
                              <input type="file" id="imageInput" hidden />
                            </label>
                            <button class="btn btn-primary d-flex send-msg-btn">
                              <i class="ti ti-send me-md-1 me-0"></i>
                              <span class="align-middle d-md-inline-block d-none" >Send</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- /Chat History -->
                  <div class="app-overlay"></div>
                </div>
              </div>
            </div>
            <!-- / Content -->
            <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>

      <!-- Drag Target Area To SlideIn Menu On Small Screens -->
      <div class="drag-target"></div>
    </div>
    <!-- / Layout wrapper -->
    <!-- / Fontawesome -->
    <script src="https://kit.fontawesome.com/cce590ac92.js" crossorigin="anonymous"></script>
    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="../static/vuexy/assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../static/vuexy/assets/vendor/libs/popper/popper.js"></script>
    <script src="../static/vuexy/assets/vendor/js/bootstrap.js"></script>
    <script src="../static/vuexy/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="../static/vuexy/assets/vendor/libs/node-waves/node-waves.js"></script>

    <script src="../static/vuexy/assets/vendor/libs/hammer/hammer.js"></script>
    <script src="../static/vuexy/assets/vendor/libs/i18n/i18n.js"></script>
    <script src="../static/vuexy/assets/vendor/libs/typeahead-js/typeahead.js"></script>

    <script src="../static/vuexy/assets/vendor/js/menu.js"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="../static/vuexy/assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js"></script>

    <!-- Main JS -->
    <script src="../static/vuexy/assets/js/main.js"></script>

    <!-- Page JS -->
    <script src="../static/vuexy/assets/js/app-chat.js"></script>
      <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.9.0/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>

    <script>
      let userData;
      let base64Image = ''

        $("#imageInput").change(function () {
            var selectedFile = this.files[0];

            if (selectedFile) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    var image = new Image();
                    image.classList.add("rounded", "pt-1", "mb-3")
                    image.height = "100"
                    image.width = "100"
                    image.alt = "User avatar"
                    image.src = e.target.result;
                    base64Image = e.target.result;

                    $("#imageContainer").empty().text($("#imageInput").val())

                };

                reader.readAsDataURL(selectedFile);

            }
        });

      const socketio_url = 'http://' + window.location.hostname + ':8001'
      const socket = io(socketio_url);


      socket.on('connect', () => {
        console.log('Connected to server');
      });
      socket.on('disconnect', () => {
        console.log('Disconnected to server');
      });

      socket.on('joined_user', (data) => {
        const usersList = $('#online-users-list');
        usersList.html('');
        if (data['users'].length > 0) {
                setUserChat(data['users'])
        }

      });

      $('.send-msg-btn').on('click',function () {
        sendMessage()
      })
      $('#messageText').keyup(function (e) {
          if (e.keyCode === 13) {  // enter, return
              sendMessage()
          }
      })
      socket.on('new_message', (data) => {
            setMessages(userData['id'], data['message'])
            $('#chatBody').scrollTop($('#chatBody')[0].scrollHeight)
      });

      function sendMessage() {
            let text = $('#messageText').val()
            if (text.length && $.trim(text).length || base64Image !== '') {
                let send_message_api_url = window.location.origin + "/api/v1/send_message"
                $.ajax({
                    method: 'post',
                    dataType: 'json',
                    headers: {
                        "Content-Type": 'application/json',
                    },
                    url: send_message_api_url,
                    data: JSON.stringify({
                        "text": text,
                        "image": base64Image
                    }),
                    success: function (data) {
                        $('#messageText').val('');
                        base64Image = ''
                    }
                })
            }
        }


      function setUserChat(users) {
            var userList = $.map(users, function (elem) {
                return parseInt(elem, 10);
            });
            let get_user_api_url = window.location.origin + "/api/v1/online_users"
            $.ajax({
                method: 'post',
                dataType: 'json',
                headers: {
                    "Content-Type": 'application/json',
                },
                url: get_user_api_url,
                data: JSON.stringify({
                    "users": userList
                }),
                success: function (data) {
                    data.forEach((user) => {
                        let avatar = "<img src='" + user.avatar + "' alt class='h-auto rounded-circle'/>"
                        let usersList = $('#online-users-list');
                        usersList.append(
                            '<li id="user_' + user.id + '" class="chat-contact-list-item">' +
                            '<a class="d-flex align-items-center">' +
                            '<div class="flex-shrink-0 avatar avatar-online">' +
                            avatar +
                            '</div>' +
                            '<div class="chat-contact-info flex-grow-1 ms-2">' +
                            '<h6 class="chat-contact-name text-truncate m-0">' + user.username + '</h6>' +
                            '</div>' +
                            '</a>' +
                            '</li>')
                    })
                },
                error: function (data) {
                    console.log("error", data.responseJSON.detail)

                }
            })
        }


        <!-- GetContext -->
        $.ajax({
          url: `/api/v1/user_by_token`,         /* Куда отправить запрос */
          method: 'get',             /* Метод запроса (post или get) */
          dataType: "json",
          contentType: "application/json",
          success: function (data) {   /* функция которая будет выполнена после успешного запроса.  */
            userData = data
            $('.profile__img').each(function () {
              $(this).attr('src', `${data['avatar']}`)
            })
            $('.profile__username1').html(data['username'])
            socket.emit('join', {user_id: data['id'], room: data['id']});
            socket.emit('join', {user_id: data['id'], room: 'chat'});
            getChatMessages(data['id'])
          },
          error: function (xhr, status, error) {
            default_error_msg(xhr, status, error)
          }
        });

        // get messages

        function setMessages(user_id, elem) {
            let chatHistory = $('#chatHistory')
            let chatAvatar  = '<img src="' + elem.user_avatar + '"alt="Avatar" class="rounded-circle">'

            let chatImage = ''
            if (elem.image !== '')
                chatImage = '<div><img class="img-fluid rounded mt-2" height="250px" width="250px" src="' + elem.image + '"></div>'
            if (user_id === elem.user_id) {
                chatHistory.append(
                    '<li class="chat-message chat-message-right">' +
                    '<div class="d-flex overflow-hidden">' +
                    '<div class="chat-message-wrapper flex-grow-1 w-50">' +
                    '<div class="chat-message-text">' +
                    '<p class="mb-0">' +
                    elem.text
                    + '</p>' +
                    chatImage +
                    '</div>' +

                    '<div class="text-end text-muted mt-1">' +
                    '<small>' + elem.date + '</small>' +
                    '</div>' +
                    '</div>' +
                    '<div class="user-avatar flex-shrink-0 ms-3">' +
                    '<div class="avatar avatar-sm">' +
                    chatAvatar
                    + '</div>' +
                    '</div>' +
                    '</div>' +
                    ' </li>'
                )
            } else {
                chatHistory.append(
                    '<li><div class="row mb-2">' +
                    '<h6 class="m-0">' + elem.username + '</h6>' +
                    '</div></li>' +
                    '<li class="chat-message">' +
                    '<div class="d-flex overflow-hidden">' +
                    '<div class="user-avatar flex-shrink-0 me-3">' +
                    '<div class="avatar avatar-sm">' +
                    chatAvatar +
                    '</div>' +
                    '</div>' +
                    '<div class="chat-message-wrapper flex-grow-1">' +
                    '<div class="chat-message-text">' +
                    '<p class="mb-0">' + elem.text + '</p>' + chatImage +
                    '</div>' +
                    '<div class="text-muted mt-1">' +
                    '<small>' + elem.date + '</small>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</li>'
                )
            }

        }

        function getChatMessages(user_id) {

            let chat_history_api_url = window.location.origin + "/api/v1/get_chat?limit=10"
            $.ajax({
                method: 'get',
                dataType: 'json',
                headers: {
                    "Content-Type": 'application/json',
                },
                url: chat_history_api_url,
                success: function (data) {

                    var reversedArray = data.reverse();
                    reversedArray.forEach((element) => setMessages(user_id, element));
                  // $('#chatBody').scrollTop($('#chatBody')[0].scrollHeight);
                  scrollToAnchor();


                },
                error: function (data) {
                    console.log("error", data.responseJSON.detail)
                    window.location.href = '/auth_login'
                }
            })
        }
        function scrollToAnchor(){
          const t_tag = $("#chatHistory").children().last();
          setTimeout(
              function()
              {
                $('#chatBody').animate({scrollTop: t_tag.offset().top},'fast');
              }, 1000);
        }

        // get messages
       function default_error_msg(xhr, status, error){
          Swal.fire({
                position: 'center',
                icon: 'error',
                title: xhr.responseJSON['detail'],
                showConfirmButton: false,
                timer: 3000
          })
       }

        <!-- LogOut -->

       $('.logout_btn').on('click',function () {
            $.ajax({
                  url: `/api/v1/logout`,         /* Куда отправить запрос */
                  method: 'post',             /* Метод запроса (post или get) */
                  dataType: "json",
                  contentType: "application/json",
                  success: function (data) {   /* функция которая будет выполнена после успешного запроса.  */
                    window.location.href = '/login'
                  },
                  error: function (xhr, status, error) {
                    default_error_msg(xhr, status, error)
                  }
            });
            return false;
       })


         //     <!-- Chat access -->

        $('.chat__link').on('click',function (e) {
          let chat_access = window.location.origin + '/api/v1/chat_access'
          $.ajax({
                method: 'get',
                dataType: 'json',
                headers: {
                    "Content-Type": 'application/json',
                },
                url: chat_access,
              success: function (data) {
                window.location.href = '/chat'
              },
              error: function (xhr, status, error) {
                default_error_msg(xhr, status, error)
              }

            })
          return false;
        })
        // <!-- Chat access -->

    </script>
  </body>
</html>
